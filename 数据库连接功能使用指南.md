# 数据库连接功能使用指南

## 概述

SuperDataAnalysis MCP 现已支持多种数据库连接，包括 MySQL、PostgreSQL、MongoDB 和 SQLite。本指南将详细介绍如何配置和使用这些数据库连接功能。

## 支持的数据库类型

- **MySQL** - 关系型数据库
- **PostgreSQL** - 关系型数据库
- **MongoDB** - 文档型数据库
- **SQLite** - 轻量级关系型数据库

## 安装依赖

首先安装必要的数据库驱动：

```bash
# 安装所有数据库驱动
pip install python-dotenv pymysql psycopg2-binary pymongo

# 或者按需安装
pip install python-dotenv  # 环境变量管理（必需）
pip install pymysql         # MySQL支持
pip install psycopg2-binary # PostgreSQL支持
pip install pymongo         # MongoDB支持
```

## 配置方式

### 方式一：使用配置文件（推荐）

#### 1. 配置数据库连接信息

编辑 `config/database_config.json` 文件：

```json
{
  "databases": {
    "my_mysql": {
      "type": "mysql",
      "host": "localhost",
      "port": 3306,
      "database": "my_database",
      "username": "root",
      "password": "${MYSQL_PASSWORD}",
      "charset": "utf8mb4",
      "description": "我的MySQL数据库",
      "enabled": true
    },
    "my_postgres": {
      "type": "postgresql",
      "host": "localhost",
      "port": 5432,
      "database": "my_database",
      "username": "postgres",
      "password": "${POSTGRES_PASSWORD}",
      "schema": "public",
      "description": "我的PostgreSQL数据库",
      "enabled": true
    },
    "my_mongo": {
      "type": "mongodb",
      "host": "localhost",
      "port": 27017,
      "database": "my_database",
      "username": "mongo_user",
      "password": "${MONGO_PASSWORD}",
      "auth_source": "admin",
      "description": "我的MongoDB数据库",
      "enabled": true
    },
    "my_sqlite": {
      "type": "sqlite",
      "file_path": "data/my_database.db",
      "description": "我的SQLite数据库",
      "enabled": true
    }
  }
}
```

#### 2. 设置环境变量

复制 `.env.example` 为 `.env` 并填入实际密码：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
# MySQL 数据库密码
MYSQL_PASSWORD=your_actual_mysql_password

# PostgreSQL 数据库密码
POSTGRES_PASSWORD=your_actual_postgres_password

# MongoDB 数据库密码
MONGO_PASSWORD=your_actual_mongo_password
```

### 方式二：直接传递连接信息

也可以在调用时直接传递连接配置，无需预先配置文件。

## 使用方法

### 1. 管理数据库配置

#### 列出所有配置的数据库

```python
manage_database_config(action="list")
```

#### 测试数据库连接

```python
manage_database_config(
    action="test",
    config={"database_name": "my_mysql"}
)
```

#### 添加新的数据库配置

```python
manage_database_config(
    action="add",
    config={
        "database_name": "new_mysql",
        "database_config": {
            "type": "mysql",
            "host": "192.168.1.100",
            "port": 3306,
            "database": "test_db",
            "username": "test_user",
            "password": "test_password",
            "description": "测试MySQL数据库",
            "enabled": true
        }
    }
)
```

#### 删除数据库配置

```python
manage_database_config(
    action="remove",
    config={"database_name": "old_database"}
)
```

#### 重新加载配置

```python
manage_database_config(action="reload")
```

### 2. 连接数据库

#### 使用配置文件连接

```python
# 连接已配置的数据库
connect_data_source(
    source_type="database_config",
    config={"database_name": "my_mysql"}
)
```

#### 直接连接（MySQL）

```python
connect_data_source(
    source_type="mysql",
    config={
        "host": "localhost",
        "port": 3306,
        "database": "test_db",
        "username": "root",
        "password": "password",
        "charset": "utf8mb4"
    }
)
```

#### 直接连接（PostgreSQL）

```python
connect_data_source(
    source_type="postgresql",
    config={
        "host": "localhost",
        "port": 5432,
        "database": "test_db",
        "username": "postgres",
        "password": "password"
    }
)
```

#### 直接连接（MongoDB）

```python
connect_data_source(
    source_type="mongodb",
    config={
        "host": "localhost",
        "port": 27017,
        "database": "test_db",
        "username": "mongo_user",
        "password": "password",
        "auth_source": "admin"
    }
)
```

### 3. 查询外部数据库

#### SQL 查询（MySQL/PostgreSQL/SQLite）

```python
# 查询 MySQL 数据库
query_external_database(
    database_name="my_mysql",
    query="SELECT * FROM users WHERE age > 18",
    limit=100
)

# 查询 PostgreSQL 数据库
query_external_database(
    database_name="my_postgres",
    query="SELECT name, email FROM customers ORDER BY created_at DESC",
    limit=50
)
```

#### MongoDB 查询

```python
# MongoDB 查询（JSON 格式）
query_external_database(
    database_name="my_mongo",
    query='{
        "collection": "users",
        "operation": "find",
        "filter": {"age": {"$gt": 18}}
    }',
    limit=100
)
```

## 安全特性

### 1. 环境变量保护

- 敏感信息（如密码）通过环境变量管理
- 配置文件中使用 `${VAR_NAME}` 格式引用环境变量
- `.env` 文件不会被提交到版本控制系统

### 2. 查询安全

- 默认禁止写操作（INSERT、UPDATE、DELETE等）
- 可配置允许的操作类型
- 查询结果自动限制行数
- 连接超时保护

### 3. 配置验证

- 连接前自动验证配置完整性
- 支持连接测试功能
- 详细的错误信息和日志记录

## 配置选项说明

### MySQL 配置

```json
{
  "type": "mysql",
  "host": "数据库主机地址",
  "port": 3306,
  "database": "数据库名称",
  "username": "用户名",
  "password": "密码或环境变量引用",
  "charset": "字符集（可选，默认utf8mb4）",
  "description": "描述信息（可选）",
  "enabled": true
}
```

### PostgreSQL 配置

```json
{
  "type": "postgresql",
  "host": "数据库主机地址",
  "port": 5432,
  "database": "数据库名称",
  "username": "用户名",
  "password": "密码或环境变量引用",
  "schema": "模式名（可选，默认public）",
  "description": "描述信息（可选）",
  "enabled": true
}
```

### MongoDB 配置

```json
{
  "type": "mongodb",
  "host": "数据库主机地址",
  "port": 27017,
  "database": "数据库名称",
  "username": "用户名（可选）",
  "password": "密码或环境变量引用（可选）",
  "auth_source": "认证数据库（可选，默认admin）",
  "description": "描述信息（可选）",
  "enabled": true
}
```

### SQLite 配置

```json
{
  "type": "sqlite",
  "file_path": "数据库文件路径",
  "description": "描述信息（可选）",
  "enabled": true
}
```

## 常见问题

### Q: 如何处理连接超时？

A: 在 `config/database_config.json` 中的 `default_limits` 部分可以配置超时时间：

```json
{
  "default_limits": {
    "query_timeout": 30,
    "connection_pool_size": 5,
    "retry_attempts": 3,
    "retry_delay": 1
  }
}
```

### Q: 如何启用写操作？

A: 在安全配置中设置：

```json
{
  "security": {
    "allow_write_operations": true,
    "blocked_keywords": []
  }
}
```

### Q: 如何处理大量数据查询？

A: 使用 `limit` 参数控制返回行数，避免内存溢出：

```python
query_external_database(
    database_name="my_database",
    query="SELECT * FROM large_table",
    limit=1000  # 限制返回1000行
)
```

### Q: 如何查看连接状态？

A: 使用测试连接功能：

```python
manage_database_config(
    action="test",
    config={"database_name": "my_database"}
)
```

## 最佳实践

1. **使用环境变量**：将敏感信息存储在环境变量中
2. **定期测试连接**：确保数据库连接正常
3. **合理设置限制**：避免查询过大的数据集
4. **使用描述信息**：为每个数据库配置添加清晰的描述
5. **定期备份配置**：备份重要的数据库配置文件
6. **监控日志**：关注连接和查询的日志信息

## 示例场景

### 场景1：数据迁移

```python
# 1. 连接源数据库
connect_data_source(
    source_type="mysql",
    config={"host": "old-server", "database": "old_db", ...}
)

# 2. 查询数据
query_external_database(
    database_name="old_mysql",
    query="SELECT * FROM users"
)

# 3. 导出到本地
export_data(
    export_type="csv",
    data_source="users_data",
    file_path="migration/users.csv"
)
```

### 场景2：跨数据库分析

```python
# 1. 连接多个数据库
connect_data_source(source_type="database_config", config={"database_name": "mysql_sales"})
connect_data_source(source_type="database_config", config={"database_name": "postgres_users"})

# 2. 分别查询数据
query_external_database(database_name="mysql_sales", query="SELECT * FROM orders")
query_external_database(database_name="postgres_users", query="SELECT * FROM customers")

# 3. 在本地进行关联分析
analyze_data(analysis_type="correlation", table_name="combined_data")
```

这个功能大大扩展了 SuperDataAnalysis MCP 的数据源支持能力，让 AI 能够便捷地访问各种类型的数据库，同时保证了安全性和易用性。