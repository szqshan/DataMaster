# 数据库连接功能扩展方案

## 📋 需求分析

### 核心需求
1. **多数据库支持**：MySQL、MongoDB、SQLite、PostgreSQL
2. **便捷连接**：AI自动调用工具获取数据
3. **隐私保护**：支持配置文件存储连接信息
4. **统一接口**：与现有临时数据库使用方式一致

## 🏗️ 技术架构设计

### 1. 配置管理系统

#### 配置文件结构 (`config/database_config.json`)
```json
{
  "databases": {
    "mysql_prod": {
      "type": "mysql",
      "host": "localhost",
      "port": 3306,
      "database": "production_db",
      "username": "user",
      "password": "password",
      "charset": "utf8mb4",
      "description": "生产环境MySQL数据库"
    },
    "mongo_analytics": {
      "type": "mongodb",
      "host": "localhost",
      "port": 27017,
      "database": "analytics",
      "username": "mongo_user",
      "password": "mongo_pass",
      "auth_source": "admin",
      "description": "分析数据MongoDB"
    },
    "postgres_warehouse": {
      "type": "postgresql",
      "host": "localhost",
      "port": 5432,
      "database": "warehouse",
      "username": "postgres",
      "password": "postgres",
      "schema": "public",
      "description": "数据仓库PostgreSQL"
    },
    "local_sqlite": {
      "type": "sqlite",
      "file_path": "data/local.db",
      "description": "本地SQLite数据库"
    }
  },
  "default_limits": {
    "query_timeout": 30,
    "max_rows": 10000,
    "connection_pool_size": 5
  }
}
```

#### 环境变量支持 (`.env`)
```env
# 敏感信息可通过环境变量配置
MYSQL_PROD_PASSWORD=your_secure_password
MONGO_ANALYTICS_PASSWORD=your_mongo_password
POSTGRES_WAREHOUSE_PASSWORD=your_postgres_password
```

### 2. 数据库连接管理器

#### 核心类设计
```python
class DatabaseManager:
    def __init__(self):
        self.connections = {}
        self.config = self._load_config()
    
    def get_connection(self, db_name: str):
        """获取数据库连接"""
        pass
    
    def test_connection(self, db_name: str) -> bool:
        """测试数据库连接"""
        pass
    
    def list_databases(self) -> list:
        """列出所有配置的数据库"""
        pass
```

### 3. 统一数据接口

#### 数据源连接工具扩展
```python
@mcp.tool()
def connect_data_source(
    source_type: str,
    config: dict = None,
    database_name: str = None,  # 新增：配置文件中的数据库名
    target_table: str = None
) -> str:
    """
    数据源连接路由器（扩展版）
    
    Args:
        source_type: 数据源类型 (mysql|mongodb|sqlite|postgresql|excel|csv)
        config: 连接配置参数（直接传递）或 None（使用配置文件）
        database_name: 配置文件中的数据库名称（当config为None时使用）
        target_table: 目标表名（可选）
    """
```

### 4. 使用方式设计

#### 方式1：直接传递连接信息
```python
# MySQL连接
connect_data_source(
    source_type="mysql",
    config={
        "host": "localhost",
        "database": "sales_db",
        "username": "user",
        "password": "pass",
        "query": "SELECT * FROM products LIMIT 1000"
    },
    target_table="products_data"
)
```

#### 方式2：使用配置文件（推荐）
```python
# 使用预配置的数据库
connect_data_source(
    source_type="mysql",
    database_name="mysql_prod",  # 引用配置文件中的数据库
    config={
        "query": "SELECT * FROM products LIMIT 1000"
    },
    target_table="products_data"
)
```

## 🔧 实现计划

### 阶段1：基础架构（第1步）
- [ ] 创建配置管理模块
- [ ] 实现数据库连接管理器
- [ ] 添加必要的依赖包

### 阶段2：数据库连接器（第2-5步）
- [ ] MySQL连接器实现
- [ ] PostgreSQL连接器实现
- [ ] MongoDB连接器实现
- [ ] SQLite连接器增强

### 阶段3：工具集成（第6步）
- [ ] 扩展connect_data_source工具
- [ ] 添加数据库管理工具
- [ ] 更新错误处理机制

### 阶段4：测试验证（第7步）
- [ ] 单元测试
- [ ] 集成测试
- [ ] 文档更新

## 📦 依赖包需求

```txt
# 现有依赖
pandas>=1.5.0
sqlite3  # 内置
numpy>=1.21.0
scipy>=1.9.0
mcp>=0.1.0
openpyxl>=3.0.0

# 新增依赖
mysql-connector-python>=8.0.0  # MySQL
psycopg2-binary>=2.9.0          # PostgreSQL
pymongo>=4.0.0                  # MongoDB
sqlalchemy>=1.4.0               # 统一ORM接口
python-dotenv>=0.19.0           # 环境变量支持
```

## 🔒 安全特性

### 1. 连接信息保护
- 配置文件支持环境变量引用
- 敏感信息不记录到日志
- 连接池管理，避免频繁连接

### 2. 查询安全
- SQL注入防护
- 查询超时限制
- 结果集大小限制
- 只读权限建议

### 3. 错误处理
- 连接失败友好提示
- 权限不足错误处理
- 网络异常重试机制

## 🎯 用户体验设计

### 1. 配置向导
```python
# 新增工具：配置数据库连接
setup_database_connection(
    name="my_mysql",
    type="mysql",
    host="localhost",
    database="mydb",
    username="user",
    save_password=False  # 是否保存密码到配置文件
)
```

### 2. 连接测试
```python
# 新增工具：测试数据库连接
test_database_connection(
    database_name="mysql_prod"
)
```

### 3. 数据库浏览
```python
# 扩展工具：浏览数据库结构
get_data_info(
    info_type="databases",  # 新增：列出所有配置的数据库
    database_name="mysql_prod"
)
```

## 💡 优势特点

1. **统一接口**：所有数据库使用相同的工具调用方式
2. **配置灵活**：支持直接传参和配置文件两种方式
3. **安全可靠**：完善的安全机制和错误处理
4. **易于扩展**：模块化设计，便于添加新的数据库类型
5. **用户友好**：简单的配置和使用方式

## 🚀 实施建议

### 开发顺序
1. **先实现MySQL和PostgreSQL**（最常用的关系型数据库）
2. **再实现MongoDB**（文档型数据库）
3. **最后增强SQLite**（完善现有功能）

### 测试策略
- 每个数据库类型独立测试
- 使用Docker容器搭建测试环境
- 模拟各种连接异常情况

---

**总结**：此方案将大幅提升SuperDataAnalysis MCP的数据源支持能力，使其能够连接主流数据库，同时保持简单易用的特点。通过配置文件管理，既保护了用户隐私，又提供了便捷的使用体验。